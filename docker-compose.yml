networks:
  redis-privatenet:
    driver: bridge

volumes:
  redis-standalone-data:
  redis-replication-master-data:
  redis-replication-slave-data:
  redis-sentinel-master-data:
  redis-sentinel-slave-data:
  redis-sentinel-data:
  redis-cluster-data:


services:
  # ========== 1. 单机模式 (Standalone) ==========
  redis-standalone:
    image: bitnami/redis:latest
    container_name: redis-standalone
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_AOF_ENABLED=no
    networks:
      - redis-privatenet
    ports:
      - "6380:6379"
    volumes:
      - redis-standalone-data:/bitnami/redis/data
    restart: unless-stopped

  # ========== 2. 主从复制模式 (Master-Slave Replication) ==========
  # 主节点
  redis-replication-master:
    image: bitnami/redis:latest
    container_name: redis-replication-master
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_REPLICATION_MODE=master
      - REDIS_AOF_ENABLED=no
    networks:
      - redis-privatenet
    ports:
      - "6381:6379"
    volumes:
      - redis-replication-master-data:/bitnami/redis/data
    restart: unless-stopped

  # 从节点
  redis-replication-slave:
    image: bitnami/redis:latest
    container_name: redis-replication-slave
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_REPLICATION_MODE=replica
      - REDIS_MASTER_HOST=redis-replication-master
      - REDIS_MASTER_PORT_NUMBER=6379
      - REDIS_MASTER_PASSWORD=${REDIS_PASSWORD}
      - REDIS_AOF_ENABLED=no
    networks:
      - redis-privatenet
    ports:
      - "6382:6379"
    volumes:
      - redis-replication-slave-data:/bitnami/redis/data
    depends_on:
      - redis-replication-master
    restart: unless-stopped

  # ========== 3. 哨兵模式 (Sentinel) ==========
  # 主节点
  redis-sentinel-master:
    image: bitnami/redis:latest
    container_name: redis-sentinel-master
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_REPLICATION_MODE=master
      - REDIS_AOF_ENABLED=no
    networks:
      - redis-privatenet
    ports:
      - "6383:6379"
    volumes:
      - redis-sentinel-master-data:/bitnami/redis/data
    restart: unless-stopped

  # 从节点
  redis-sentinel-slave:
    image: bitnami/redis:latest
    container_name: redis-sentinel-slave
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_REPLICATION_MODE=replica
      - REDIS_MASTER_HOST=redis-sentinel-master
      - REDIS_MASTER_PORT_NUMBER=6379
      - REDIS_MASTER_PASSWORD=${REDIS_PASSWORD}
      - REDIS_AOF_ENABLED=no
    networks:
      - redis-privatenet
    ports:
      - "6384:6379"
    volumes:
      - redis-sentinel-slave-data:/bitnami/redis/data
    depends_on:
      - redis-sentinel-master
    restart: unless-stopped

  # 哨兵节点
  redis-sentinel:
    image: bitnami/redis-sentinel:latest
    container_name: redis-sentinel
    environment:
      - REDIS_SENTINEL_DOWN_AFTER_MILLISECONDS=5000
      - REDIS_SENTINEL_FAILOVER_TIMEOUT=60000
      - REDIS_SENTINEL_QUORUM=2
      - REDIS_MASTER_SET=mymaster
      - REDIS_MASTER_HOST=redis-sentinel-master
      - REDIS_MASTER_PORT_NUMBER=6379
      - REDIS_MASTER_PASSWORD=${REDIS_PASSWORD}
    networks:
      - redis-privatenet
    ports:
      - "6385:26379"
    volumes:
      - redis-sentinel-data:/bitnami/redis-sentinel/data
    depends_on:
      - redis-sentinel-master
      - redis-sentinel-slave
    restart: unless-stopped

  # ========== 4. 集群模式 (Cluster) ==========
  redis-cluster:
    image: grokzen/redis-cluster:latest
    container_name: redis-cluster
    environment:
      - IP=0.0.0.0
      - INITIAL_PORT=7000
      - MASTERS=3
      - SLAVES_PER_MASTER=1
    networks:
      - redis-privatenet
    ports:
      # grokzen 内部使用 7000-7005，映射到宿主机 7001-7006
      - "7001:7000"
      - "7002:7001"
      - "7003:7002"
      - "7004:7003"
      - "7005:7004"
      - "7006:7005"
      # 集群总线端口
      - "17001:17000"
      - "17002:17001"
      - "17003:17002"
      - "17004:17003"
      - "17005:17004"
      - "17006:17005"
    volumes:
      - redis-cluster-data:/data
    restart: unless-stopped

